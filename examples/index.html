<!doctype html>
<html lang="en">
<head>
  <meta name="charset" content="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- twitter bootstrap CSS stylesheet - included to make things pretty, not needed or used by cornerstone -->
  <link href="bootstrap.min.css" rel="stylesheet">
  <link href="cornerstone.min.css" rel="stylesheet">
  <link href="example.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header id="main-header">
      <h1>NIFTI loading</h1>
      <h2><small class="text-muted">Example of displaying a NIFTI image using Cornerstone</small></h2>
      <p class="lead">
        Enter a URL for a NIFTI file to view it using cornerstone.
        <button id='toggle-more-info' class="btn btn-outline-info" type="button">
            More info
        </button>
      </p>
    </header>
    <div id="more-info" class="collapse">
      <p>
        This example illustrates how to use the cornerstone-nifti-image-loader to get a NIFTI
        file and display it in your web browser using cornerstone.
      </p>
      <p>
        Use the hash fragment (<code>#</code>) to specify which frame (slice) to display
        from an object (defaults to the first frame if not specified). Example:
        <dl class="row">
          <dt class="col-sm-3 col-md-5 text-right">URL: <code>brain.nii</code></dt>
          <dd class="col-sm-9 col-md-7">Loads the first frame (slice) of the data</dd>
          <dt class="col-sm-3 col-md-5 text-right">URL: <code>brain.nii#15</code></dt>
          <dd class="col-sm-9 col-md-7">Loads the 15th frame (slice) of the data</dd>
        </dl>
      </p>
      <strong>If you get an HTTP error and your URL is correct, it is probably because the server is not configured to
        allow <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">Cross Origin Requests</a>.
        Most browsers will allow you to enable cross domain requests via settings or command line switches,
        you can start chrome with the command line switch <code>--disable-web-security</code> to allow cross origin requests.
        See the  <a href="http://enable-cors.org/">Enable CORS site</a> for information about CORS.
      </strong>
      <br>
      <br>
      <p>
        Looking for a CORS proxy?  Try <a href="https://www.npmjs.com/package/corsproxy">CORSProxy</a>
      </p>
      <strong>Use of this example require IE10+ or any other modern browser.</strong>
      <hr>
    </div>
    <div id="load-progress">Image Load Progress:</div>

    <div class="row">
      <div class="col">
        <form id="form">
          <div class="form-group form-row">
            <label class="col-form-label col-sm-1" for="nifti-URL">URL</label>
            <div class="col-sm-7">
              <input class="form-control" type="text" id="nifti-URL" placeholder="Enter NIFTI URL" value="data/avg152T1_LR_nifti.nii" list="sample-nifti-files">
              <datalist id="sample-nifti-files">
                <option value="data/avg152T1_LR_nifti.nii">data/avg152T1_LR_nifti.nii (uncompressed, 903 KB)</option>
                <option value="data/sample_image.nii.gz">data/sample_image.nii.gz (compressed, 1,5 MB)</option>
              </datalist>
            </div>
            <div class="col-sm-3">
              <button class="btn btn-primary" type="button" id="download-and-view">Download and View</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- <input type="checkbox" id="toggleModalityLUT">Apply Modality LUT</input>
    <input type="checkbox" id="toggleVOILUT">Apply VOI LUT</input> -->

    <section id="image-and-data-info">
      <div id="nifti-image-container"
         oncontextmenu="return false"
         class='disable-selection noIbar'
         unselectable='on'
         onselectstart='return false;'
         onmousedown='return false;'>
        <div id="nifti-image"></div>
      </div>
      <div id="nifti-image-data">
        <span>Transfer Syntax: </span><span id="transferSyntax"></span><br>
        <span>SOP Class: </span><span id="sopClass"></span><br>
        <span>Samples Per Pixel: </span><span id="samplesPerPixel"></span><br>
        <span>Photometric Interpretation: </span><span id="photometricInterpretation"></span><br>
        <span>Number Of Frames: </span><span id="numberOfFrames"></span><br>
        <span>Planar Configuration: </span><span id="planarConfiguration"></span><br>
        <span>Rows: </span><span id="rows"></span><br>
        <span>Columns: </span><span id="columns"></span><br>
        <span>Pixel Spacing: </span><span id="pixelSpacing"></span><br>
        <span>Bits Allocated: </span><span id="bitsAllocated"></span><br>
        <span>Bits Stored: </span><span id="bitsStored"></span><br>
        <span>High Bit: </span><span id="highBit"></span><br>
        <span>Pixel Representation: </span><span id="pixelRepresentation"></span><br>
        <span>WindowCenter: </span><span id="windowCenter"></span><br>
        <span>WindowWidth: </span><span id="windowWidth"></span><br>
        <span>RescaleIntercept: </span><span id="rescaleIntercept"></span><br>
        <span>RescaleSlope: </span><span id="rescaleSlope"></span><br>
        <span>Basic Offset Table Entries: </span><span id="basicOffsetTable"></span><br>
        <span>Fragments: </span><span id="fragments"></span><br>
        <span>Max Stored Pixel Value: </span><span id="minStoredPixelValue"></span><br>
        <span>Min Stored Pixel Value: </span><span id="maxStoredPixelValue"></span><br>
        <span>Total Time: </span><span id="totalTime"></span><br>
        <span>Load Time: </span><span id="loadTime"></span><br>
        <span>Decode Time: </span><span id="decodeTime"></span><br>
      </div>
    </section>
  </div>
</body>

<!-- include the cornerstone library -->
<script src="cornerstone.js"></script>
<script src="cornerstoneMath.js"></script>
<script src="cornerstoneTools.js"></script>

<!-- include the nifti reader NIFTI-Reader-JS library  -->
<script src="nifti-reader.js"></script>

<!-- include the cornerstoneNIFTIImageLoader library -->
<script src="../../dist/cornerstoneNIFTIImageLoader.js"></script>

<script>
  cornerstoneNIFTIImageLoader.external.cornerstone = cornerstone;

  let loaded = false;

  function loadAndViewImage(imageId) {
    const element = document.getElementById('nifti-image');

    try {
      const start = new Date().getTime();
      cornerstone.loadAndCacheImage(imageId).then(function(image) {
        console.log(image);
        const stack = {
          currentImageIdIndex: 0,
          // 91: this is hardcoded because the image loader still has to expose
          //     the nifti metadata. 91 is the number of slices of the default
          //     sample .nii file
          imageIds: Array.from(Array(91), (_, i) => `${imageId}#${i}`)
        };

        const viewport = cornerstone.getDefaultViewportForImage(element, image);
        viewport.vflip = true;
        viewport.hflip = true;
        cornerstone.displayImage(element, image, viewport);
        if(loaded === false) {
          cornerstoneTools.addStackStateManager(element, ['stack', 'wwwc', 'pan', 'zoom']);
          cornerstoneTools.addToolState(element, 'stack', stack);
          cornerstoneTools.mouseInput.enable(element);
          cornerstoneTools.mouseWheelInput.enable(element);
          cornerstoneTools.wwwc.activate(element, 1); // ww/wc is the default tool for left mouse button
          cornerstoneTools.pan.activate(element, 2); // pan is the default tool for middle mouse button
          cornerstoneTools.zoom.activate(element, 4); // zoom is the default tool for right mouse button
          cornerstoneTools.stackScrollWheel.activate(element);
          cornerstoneTools.orientationMarkers.enable(element);
          loaded = true;
        }

        // function getPixelRepresentation() {
        //     const value = image.data.uint16('x00280103');
        //     if(value === undefined) {
        //         return;
        //     }
        //     return value + (value === 0 ? ' (unsigned)' : ' (signed)');
        // }
        //
        // function getPlanarConfiguration() {
        //     const value = image.data.uint16('x00280006');
        //     if(value === undefined) {
        //         return;
        //     }
        //     return value + (value === 0 ? ' (pixel)' : ' (plane)');
        // }

        // document.getElementById('samplesPerPixel').textContent = image.data.uint16('x00280002');
        // document.getElementById('photometricInterpretation').textContent = image.data.string('x00280004');
        // document.getElementById('numberOfFrames').textContent = image.data.string('x00280008');
        // document.getElementById('planarConfiguration').textContent = getPlanarConfiguration();
        // document.getElementById('rows').textContent = image.data.uint16('x00280010');
        // document.getElementById('columns').textContent = image.data.uint16('x00280011');
        // document.getElementById('pixelSpacing').textContent = image.data.string('x00280030');
        // document.getElementById('bitsAllocated').textContent = image.data.uint16('x00280100');
        // document.getElementById('bitsStored').textContent = image.data.uint16('x00280101');
        // document.getElementById('highBit').textContent = image.data.uint16('x00280102');
        // document.getElementById('pixelRepresentation').textContent = getPixelRepresentation();
        // document.getElementById('windowCenter').textContent = image.data.string('x00281050');
        // document.getElementById('windowWidth').textContent = image.data.string('x00281051');
        // document.getElementById('rescaleIntercept').textContent = image.data.string('x00281052');
        // document.getElementById('rescaleSlope').textContent = image.data.string('x00281053');
        // document.getElementById('basicOffsetTable').textContent = image.data.elements.x7fe00010.basicOffsetTable ? image.data.elements.x7fe00010.basicOffsetTable.length : '';
        // document.getElementById('fragments').textContent = image.data.elements.x7fe00010.fragments ? image.data.elements.x7fe00010.fragments.length : '';
        // document.getElementById('minStoredPixelValue').textContent = image.minPixelValue;
        // document.getElementById('maxStoredPixelValue').textContent = image.maxPixelValue;
        // const end = new Date().getTime();
        // const time = end - start;
        // document.getElementById('totalTime').textContent = `${time}ms`;
        // document.getElementById('loadTime').textContent = `${image.loadTimeInMS}ms`;
        // document.getElementById('decodeTime').textContent = `${image.decodeTimeInMS}ms`;

      }, function(err) {
        throw err;
        alert(err);
      });
    } catch(err) {
      throw err;
      alert(err);
    }
  }

  function downloadAndView() {
    let url = document.getElementById('nifti-URL').value;

    // prefix the url with nifti: so cornerstone can find the image loader
    loadAndViewImage(`nifti:${url}`);
  }

  cornerstone.events.addEventListener('cornerstoneimageloadprogress', function(event) {
    const eventData = event.detail;
    const loadProgress = document.getElementById('load-progress');
    loadProgress.textContent = `Image Load Progress: ${eventData.percentComplete}%`;
  });

  const element = document.getElementById('nifti-image');
  cornerstone.enable(element);

  document.getElementById('download-and-view').addEventListener('click', function(e) {
    downloadAndView();
  });

  const form = document.getElementById('form');
  form.addEventListener('submit', function(e) {
    downloadAndView();
    e.preventDefault();
  });

  // document.getElementById('toggleModalityLUT').addEventListener('click', function() {
  //   var applyModalityLUT = document.getElementById('toggleModalityLUT').checked;
  //   console.log('applyModalityLUT=', applyModalityLUT);
  //   var image = cornerstone.getImage(element);
  //   var viewport = cornerstone.getViewport(element);
  //   if(applyModalityLUT) {
  //     viewport.modalityLUT = image.modalityLUT;
  //   } else {
  //     viewport.modalityLUT = undefined;
  //   }
  //   cornerstone.setViewport(element, viewport);
  // });
  //
  // document.getElementById('toggleVOILUT').addEventListener('click', function() {
  //   var applyVOILUT = document.getElementById('toggleVOILUT').checked;
  //   console.log('applyVOILUT=', applyVOILUT);
  //   var image = cornerstone.getImage(element);
  //   var viewport = cornerstone.getViewport(element);
  //   if(applyVOILUT) {
  //       viewport.voiLUT = image.voiLUT;
  //   } else {
  //       viewport.voiLUT = undefined;
  //   }
  //   cornerstone.setViewport(element, viewport);
  // });

  document.getElementById('toggle-more-info').addEventListener('click', function() {
    document.querySelector('#more-info').classList.toggle('collapse');
  });
</script>
</html>
